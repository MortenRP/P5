\section{Knowledge representation}
In this section we describe what we are going to consider knowledge in the system and how we are going to represent that knowledge. More specifically, we consider how we can model knowledge about the road network and traffic in Beijing. We consider the knowledge representation for several reasons. First of all, the raw GPS samples and map data is not really useful to reason about, as there are a lot of unnecessary details included. Thus, we want to make sure that the model adequately portrays the real roads and traffic of Beijing only with the required level of detail. Secondly, we want to be able to reason about this knowledge to later be able to find patterns in the traffic.
% WHAT is going to be in this section
% WHY are we bothering with this section?
% HOW follows from the subsections.

\subsection{Road network representation}\label{sec:road-network-rep}
% Why and what?
To represent the road network, we must model what the road network consists of. A road network generally consists of roads and intersections of roads. Obviously there are many different types of roads, such as bridges, boulevards and one-way roads, which all have different properties related to how you can travel on them. Instead of differentiating between types of roads, we can see them as a single type of road, having attributes with different values. As such, to represent the road network we use a weighted, directed graph.

% How ?
Let G be a weighted directed graph $G(V,E)$, where $V$ is the set of nodes corresponding to intersections, $E$ is the set edges corresponding to road-segments between nodes. Each edge represents the direction of a road from the origin intersection, $n_o$ to the target intersection $n_t$. That is:
\begin{align*}
  e \in E \text{ is a tuple } e=(u, v) \text{ where } u, v \in N
\end{align*}
Furthermore, two-way roads are represented as two edges,
\begin{align*}
  e_1, e_2 \text{ where } e_1 = (u, v) \text{ and } e_2=(v, u)
\end{align*}
Each edge, $e$, also has an associated weight, $weight(e)$ where
\begin{align}
weight: E \times T \times W \rightarrow \mathbb R_+
\end{align}
 is the weight function as defined more precisely in Section \ref{sec:weight-function}. 

Usually, the weight of an edge is used to choose between edges in search algorithms. Similarly, we construct our weight function for this purpose, as described in \ref{patterns:model-trees}\todo{Skal ref til weight function} 

Representing the road network as a graph is sufficient to capture the important attributes of roads and intersections, since the these attributes can be taken account for by adjusting the weight function to represent differences between different types of roads.

\subsection{Traffic representation}\label{KR:traffic}
We must also consider how to represent knowledge about previous traffic in the Road Network. Since traffic changes over time, we consider this a separate model than the model for the road network, as the traffic describes dynamic properties of the road network, whereas model of the road network represents the static properties.

From the Beijing dataset, we can find many useful properties about the traffic. More specifically, we wish to capture the notion of a person observing the state of traffic when driving on a road at a specific time. An example would be, that a driver could observe that the traffic flows at a lower speed than the speed limit on the road to work in the morning. By collecting many of such \emph{observations} of drivers at different times, we build a large set of observations that can be used to reason about how the traffic situation is at certain time periods. To capture these properties, we define a set of \emph{observations} on road segments.

Let an \emph{observation}, $o$, be:
\begin{align*}
o = (t, d, w, s, e)
\end{align*}
where
\begin{align*}
t \in T &\text{ is the time of day} \\
d \in D &\text{ is a date} \\
w \in W &\text{ is the day of the week} \\
s \in \mathbb{R} &\text{ is the speed and}\\
e \in E &\text{ is road segment where the observation was made.}
\end{align*}

From the map-matched dataset, we obtain the set of all observations on the segments in the road network, by constructing a new observation every time a vehicle is driving on the segment. Fortunately, the time of day, segment identifier, date and week of the day can directly be found in the data. The remaining problem is then to estimate the observed speed. Observations are generated on a link-to-link basis.

We have encountered a number of problems when generating observations:

\begin{enumerate}
	\item Speeds cannot be accurately calculated when there are fewer than two waypoints on a link.
	\item Sometimes, a few consecutive waypoints are identical. This is only a problem when all the waypoints are identical, as that is effectively equivalent to having only a single waypoint.
	\item The map used by TrackMatching may differ from the one used locally. In one case, a way in the TrackMatching map was represented as two separate ways in the map we used. In another, a node in the map used by TrackMatching did not exist in ours.
	\item Some of the drivers in the Beijing dataset drove in the wrong direction on a one-way road. This is either due to an error in the map (i.e. wrong classification of the road) or reckless driving.
	\item Due to the inaccuracies in GPS technology, someone staying in the same place will appear to move back and forth on a way. The same will happen in a few cases when the map-matcher includes waypoints that should have been pruned.
\end{enumerate}

These problems are solved by skipping links where they occur. This increases the average quality of observations in exchange for a slight decrease in the quantity.

\subsubsection{Estimating observation speed}\label{KR:speed}\todo{Nyligt omskrevet. Læs og ret.} \todo{mangler hvorfor vi har valgt at gøre det sådan her}
% How to estimate speed
Given a link that contains a set of road segment $E$, a sequence of coordinates $Coords = (c_1,...,c_i,...,c_n)$, and a sequence of GPS waypoints projected onto a road, $WP=(wp_1,...,wp_i,...,wp_n)$ where $c_i = (long_i, lat_i)$ $wp_i = (d_i, w_i, t_i, x_i, y_i)$, we construct a new observation $o_e$ for each $e \in E$ such that:
\begin{align*}
o_e = (t_1, d_1, w_1, S, e)
\end{align*}

where
\begin{align*}
S = median(\{s_1,...,s_i,...,s_{n-1}\})
\end{align*}
%
The speeds in $S$ are calculated using:
\begin{align*}
s_i = \frac{dist(wp_i, wp_{i+1})}{t_{i+1} - t_i} \qquad \text{ for } 0 < i < n
\end{align*}

where
\begin{align*}
dist(wp_1, wp_2) = \begin{cases} 
	gd(wp_1, wp_2) & |cbw| = 0 \\
	gd(wp_1, c_1) + gd(c_1, c_2) + ... & |cbw| > 0 \\
	 + gd(c_{m-1}, c_m) + gd(c_m, wp_2)
\end{cases}
\end{align*}

and gd(a, b) is the geodetic distance between two points, and cbw is the sequence of all coordinates $(c_1,...,c_m)$ in Coords between $wp_1$ and $wp_2$ on road segment $e$.

\subsection{Secondary preprocessing}
% Why ? --> Simple filtering of raw data, did not catch all noise data
% FILL OUT CONTENT HERE
% What ? --> We want to filter the knowledge base, specifically, the traffic knowledge, such that noise data is not considered in traffic patterns.
% How ? --> We introduce a quality measaure over the GPS sample rate and the length of the road + mapmatching error rate.
Some of the observations might have been matched to the wrong road, based on a small number of GPS samples, etc. Such observations could potentially introduce noise into the regression model and must therefore be taken into account when we construct the model trees. To accomplish this we utilise a few filters for preprocessing the observations. Only speeds below two times the speed limit are used. The remaining speeds that exceed the speed limit are lowered to the speed limit so as to not encourage speeding. Additional filters can be seen in \tabref{tab:datafiltering} (the green row is the one we use), where \emph{MSR} is the median sample rate calculated using only waypoints that are at least 1.4 metres apart, \emph{\#Wpts} is the total number of waypoints on the link, \emph{Length} is the distance driven between the first and the last waypoint in the link, and \emph{Observations} is the number of observations remaining after applying the filters.\todo{Revise when we have decided exactly which filters to use.}

%  SELECT COUNT(o.*) FROM Observations o, Segments s, Ways w, Roadtypes t WHERE o.speed > 1 AND o.speed < t.speedlimit * 2 AND o.length > 0.005 AND o.mediansamplerate <= 20 AND o.error < 100 AND numwaypoints > 4 AND o.segment = s.id AND s.way = w.id AND w.type = t.id;
\begin{table}[H]
	\centering
	\begin{tabular}{TlTlTlTlTlTlT}
		\thickhline
		\textbf{Speed}                                                                          & \textbf{Length}  & \textbf{MSR}  & \textbf{Error} & \textbf{\#Wpts} & \textbf{Observations} \\ \thickhline
		-                                                                                       & -                & -             & -              & -               & 4584306               \\ \thickhline
		\begin{tabular}[c]{@{}l@{}}\textgreater 1 km/h\\ \textless speed limit * 2\end{tabular} & \textgreater 5 m & \textless= 20 & \textless 100  & \textgreater= 5 & 269527                \\ \thickhline
		\begin{tabular}[c]{@{}l@{}}\textgreater 1 km/h\\ \textless speed limit * 2\end{tabular} & \textgreater 5 m & \textless= 20 & \textless 100  & -               & 867128                \\ \thickhline
		\begin{tabular}[c]{@{}l@{}}\textgreater 1 km/h\\ \textless speed limit * 2\end{tabular} & -                & \textless= 20 & \textless 100  & -               & 878426                \\ \thickhline
		\textless speed limit * 2                                                               & -                & \textless= 20 & \textless 100  & -               & 898774                \\ \thickhline
		\textless= speed limit                                                                  & -                & \textless= 20 & \textless 100  & -               & 861766                \\ \thickhline
		\textless= speed limit                                                                  & -                & \textless 300 & \textless 100  & -               & 2861949               \\ \thickhline
		\rowcolor[HTML]{34FF34}
		\begin{tabular}[c]{@{}l@{}}\textgreater 1 km/h\\ \textless speed limit * 2\end{tabular} & \textgreater 5m  & \textless= 60 & \textless 100  & -               & 1715070               \\ \thickhline
		\begin{tabular}[c]{@{}l@{}}\textgreater 1 km/h\\ \textless speed limit * 2\end{tabular} & \textgreater 5m  & \textless= 60 & \textless 100  & \textgreater= 3 & 913779                \\ \thickhline
	\end{tabular}
	\caption{Observations remaining after using various filters. MSR = median sample rate of the link, \#Wpts = number of waypoints in the link.}
	\label{tab:datafiltering}
\end{table}

Additionally, we perform normalisation of the timestamps of observations, due to Weka3's internal representation of time being problematic when doing regression.